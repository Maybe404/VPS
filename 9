#!/bin/bash

# 版本号
VERSION="1.4"
# 默认中国IP列表源
DEFAULT_CN_URL="http://www.ipdeny.com/ipblocks/data/countries/cn.zone"
# 配置保存路径
IPSET_CONF="/etc/ipset.conf"
# 持久化服务名
SERVICE_FILE="/etc/systemd/system/ipset-persistent.service"

# 颜色定义
RED='\033[31m'
GREEN='\033[32m'
YELLOW='\033[33m'
BLUE='\033[34m'
RESET='\033[0m'

# 显示进度条
show_progress() {
    local duration=$1
    local interval=0.1
    local elapsed=0
    while [ "$(echo "$elapsed < $duration" | bc)" -eq 1 ]; do
        printf "."
        sleep $interval
        elapsed=$(echo "$elapsed + $interval" | bc)
    done
    echo ""
}

# 检查root权限
check_root() {
    if [ "$EUID" -ne 0 ]; then
        echo -e "${RED}错误：必须使用root权限运行本脚本！${RESET}"
        exit 1
    fi
}

# 安装依赖
install_dependencies() {
    echo -e "${YELLOW}[+] 正在安装必要依赖...${RESET}"
    apt update >/dev/null 2>&1 &
    show_progress 5
    apt install -y iptables ipset iptables-persistent >/dev/null 2>&1 &
    show_progress 10
    echo -e "${GREEN}[√] 依赖安装完成${RESET}"
}

# 创建ipset集合
create_ipset() {
    if ipset list china >/dev/null 2>&1; then
        echo -e "${BLUE}[i] 检测到已存在的china集合，将清空内容${RESET}"
        ipset flush china
    else
        ipset create china hash:net
    fi
}

# 下载IP列表
download_ip_list() {
    local url="$1"
    echo -e "${YELLOW}[+] 正在从 $url 下载IP列表...${RESET}"
    wget -qO /tmp/cn.zone "$url" &
    show_progress 10
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}[√] IP列表下载成功${RESET}"
        return 0
    else
        echo -e "${RED}[×] 下载失败，请检查URL有效性${RESET}"
        return 1
    fi
}

# 加载IP到集合
load_ipset() {
    echo -e "${YELLOW}[+] 正在加载IP到china集合...${RESET}"
    local total_lines=$(grep -c "^" /tmp/cn.zone)
    local current_line=0

    while read -r ip; do
        ipset add china "$ip" 2>/dev/null
        current_line=$((current_line + 1))
        progress=$((current_line * 100 / total_lines))
        echo -ne "进度: ${progress}%%\r"
    done < <(grep -v "^#\|^$" /tmp/cn.zone)
    echo -e "${GREEN}[√] 已加载 $(ipset list china | grep -c "/") 个IP段${RESET}"
}

# 配置防火墙规则
configure_iptables() {
    local ports="$1" protocol="$2"
    echo -e "${YELLOW}[+] 正在配置iptables规则...${RESET}"
    iptables-save | grep -v "china" | iptables-restore

    IFS=',' read -ra PORT_LIST <<< "$ports"
    local total_ports=${#PORT_LIST[@]}
    local current_port=0

    for port in "${PORT_LIST[@]}"; do
        if [ "$protocol" == "all" ]; then
            iptables -A INPUT -p tcp --dport "$port" -m set --match-set china src -j DROP
            iptables -A INPUT -p udp --dport "$port" -m set --match-set china src -j DROP
        else
            iptables -A INPUT -p "$protocol" --dport "$port" -m set --match-set china src -j DROP
        fi
        current_port=$((current_port + 1))
        progress=$((current_port * 100 / total_ports))
        echo -ne "进度: ${progress}%%\r"
    done
    echo -e "${GREEN}[√] 防火墙规则配置完成${RESET}"
}

# 保存配置
save_config() {
    echo -e "${YELLOW}[+] 正在保存配置...${RESET}"
    iptables-save > /etc/iptables/rules.v4
    ipset save china -f $IPSET_CONF
    if [ ! -f "$SERVICE_FILE" ]; then
        cat > "$SERVICE_FILE" <<EOF
[Unit]
Description=Load ipsets
Before=network-pre.target

[Service]
Type=oneshot
ExecStart=/sbin/ipset restore -f $IPSET_CONF

[Install]
WantedBy=multi-user.target
EOF
        systemctl enable ipset-persistent >/dev/null 2>&1
    fi
    echo -e "${GREEN}[√] 配置已持久化，重启后自动生效${RESET}"
}

# 更新IP列表
update_ip_list() {
    local url
    read -p "输入新的IP列表URL（留空使用默认源）：" url
    url=${url:-$DEFAULT_CN_URL}
    if download_ip_list "$url"; then
        ipset flush china
        load_ipset
        ipset save china -f $IPSET_CONF
        echo -e "${GREEN}[√] IP列表更新完成${RESET}"
    fi
}

# 主函数
main() {
    check_root
    install_dependencies
    create_ipset
    update_ip_list
}

# 执行主函数
main